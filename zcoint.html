<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V14s Cointegration Dashboard</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --border-color: #30363d;
            --accent-color: #34c759;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* --- Header & Layout --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.2rem;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .grid-container { grid-template-columns: 350px 1fr; }
        }

        /* --- Cards --- */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .card-header {
            background-color: #21262d;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 15px;
        }

        /* --- Config List --- */
        .config-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 0.95rem;
        }

        .config-item:last-child { border-bottom: none; }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .btn-icon:hover { opacity: 1; }

        /* --- Add Pair Form --- */
        .add-form {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .input-dark {
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            text-transform: uppercase;
        }

        .btn-sm {
            background-color: #1f6feb;
            color: white;
            border: none;
            padding: 0 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        /* --- Results Area --- */
        .action-bar {
            margin-bottom: 20px;
            text-align: right;
        }

        .btn-run {
            background: linear-gradient(180deg, #2ea043, #238636);
            color: white;
            border: 1px solid rgba(240,246,252,0.1);
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 1px 0 rgba(27,31,35,0.1);
            width: 100%;
        }

        .btn-run:hover { background: #2ea043; }
        .btn-run:disabled { background: #333; opacity: 0.7; cursor: not-allowed; }

        .result-item {
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .res-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .res-pair { font-size: 1.1rem; font-weight: 700; color: #fff; }
        
        .badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            border: 1px solid transparent;
        }
        .b-excellent { background: rgba(52,199,89,0.15); color: #34c759; border-color: #34c759; }
        .b-good { background: rgba(52,199,89,0.15); color: #34c759; border-color: #34c759; }
        .b-moderate { background: rgba(255,204,0,0.15); color: #ffcc00; border-color: #ffcc00; }
        .b-not_suitable { background: rgba(255,59,48,0.15); color: #ff3b30; border-color: #ff3b30; }

        .res-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: #161b22;
            padding: 8px;
            border-radius: 4px;
        }
        
        .stat-box div:first-child { font-size: 0.7rem; opacity: 0.7; }
        .stat-box div:last-child { color: var(--text-primary); font-weight: 500; }

        /* --- Toast --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #21262d; border: 1px solid var(--accent-color);
            padding: 12px 20px; border-radius: 6px;
            color: white; display: none; z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üîó V14s Validator</h1>
        <span style="font-size:0.8rem; color:#888" id="status">Ready</span>
    </div>

    <div class="grid-container">
        
        <div class="card">
            <div class="card-header">
                <span>‚öôÔ∏è Configured Pairs</span>
                <button class="btn-icon" onclick="fetchConfig()" title="Refresh Config">üîÑ</button>
            </div>
            <div class="card-body">
                <ul class="config-list" id="configList">
                    <li style="text-align:center; color:#666; padding:10px;">Loading...</li>
                </ul>

                <div class="add-form">
                    <input type="text" id="addA" class="input-dark" placeholder="SOL">
                    <span style="align-self:center">/</span>
                    <input type="text" id="addB" class="input-dark" placeholder="JUP">
                    <button class="btn-sm" onclick="addPair()">+</button>
                </div>
            </div>
        </div>

        <div>
            <div class="action-bar">
                <button class="btn-run" id="runBtn" onclick="runTest()">‚ñ∂ Run Cointegration Test</button>
            </div>

            <div id="resultsArea">
                <div style="text-align:center; color:#444; padding: 40px;">
                    Results will appear here...
                </div>
            </div>
        </div>

    </div>

    <div class="toast" id="toast">Message</div>

    <script>
        // Use relative path so it works on localhost and tailscale
        const API = ''; 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfig();
            fetchResults();
        });

        // --- API CALLS ---

        async function fetchConfig() {
            try {
                const res = await fetch(`${API}/api/config?t=${Date.now()}`);
                const data = await res.json();
                renderConfig(data.pairs_to_test || []);
            } catch (e) {
                console.error("Config fetch failed", e);
            }
        }

        async function fetchResults() {
            try {
                const res = await fetch(`${API}/api/results?t=${Date.now()}`);
                if (!res.ok) return;
                const data = await res.json();
                if(data.results) renderResults(data);
            } catch (e) {
                console.error("Results fetch failed", e);
            }
        }

        async function runTest() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.innerText = "‚è≥ Testing... (this takes ~30s)";
            document.getElementById('status').innerText = "Running analysis...";

            try {
                const res = await fetch(`${API}/api/run-test`, { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    showToast("‚úÖ Test Complete");
                    fetchResults();
                } else {
                    showToast("‚ùå Error: " + data.message);
                }
            } catch (e) {
                showToast("‚ùå Network Error");
            } finally {
                btn.disabled = false;
                btn.innerText = "‚ñ∂ Run Cointegration Test";
                document.getElementById('status').innerText = "Ready";
            }
        }

        async function addPair() {
            const a = document.getElementById('addA').value.toUpperCase().trim();
            const b = document.getElementById('addB').value.toUpperCase().trim();
            if(!a || !b) return;

            try {
                const res = await fetch(`${API}/api/add-pair`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset1: a, asset2: b})
                });
                if(res.ok) {
                    showToast("Added " + a + "/" + b);
                    document.getElementById('addA').value = "";
                    document.getElementById('addB').value = "";
                    fetchConfig();
                }
            } catch(e) { showToast("Error adding pair"); }
        }

        async function removePair(a, b) {
            if(!confirm(`Remove ${a}/${b}?`)) return;
            try {
                const res = await fetch(`${API}/api/remove-pair`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset1: a, asset2: b})
                });
                if(res.ok) {
                    fetchConfig();
                    showToast("Removed pair");
                }
            } catch(e) { showToast("Error removing pair"); }
        }

        // --- RENDERERS ---

        function renderConfig(pairs) {
            const list = document.getElementById('configList');
            if(pairs.length === 0) {
                list.innerHTML = '<li style="text-align:center; padding:10px; color:#555">No pairs configured</li>';
                return;
            }
            
            list.innerHTML = pairs.map(p => `
                <li class="config-item">
                    <span>${p.asset1} / ${p.asset2}</span>
                    <button class="btn-icon" onclick="removePair('${p.asset1}', '${p.asset2}')">üóëÔ∏è</button>
                </li>
            `).join('');
        }

        function renderResults(data) {
            const area = document.getElementById('resultsArea');
            if(!data.results || data.results.length === 0) return;

            const timeStr = new Date(data.timestamp).toLocaleTimeString();
            document.getElementById('status').innerText = `Last Updated: ${timeStr}`;

            area.innerHTML = data.results.map((r, i) => {
                const badgeClass = `b-${r.recommendation.toLowerCase()}`;
                const hl = r.half_life_minutes ? r.half_life_minutes.toFixed(1) + 'm' : '‚àû';
                
                return `
                <div class="result-item">
                    <div class="res-top">
                        <div class="res-pair">
                            <span style="color:#666; font-size:0.9rem; margin-right:5px">#${i+1}</span>
                            ${r.asset1}/${r.asset2}
                        </div>
                        <div class="badge ${badgeClass}">${r.recommendation}</div>
                    </div>
                    <div class="res-stats">
                        <div class="stat-box"><div>P-Value</div><div>${r.p_value ? r.p_value.toFixed(4) : '-'}</div></div>
                        <div class="stat-box"><div>Half-Life</div><div>${hl}</div></div>
                        <div class="stat-box"><div>Z-Score</div><div>${r.score ? r.score.toFixed(2) : '-'}</div></div>
                        <div class="stat-box"><div>Coint?</div><div>${r.is_cointegrated ? 'Yes' : 'No'}</div></div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>