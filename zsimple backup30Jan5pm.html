<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Trade Monitor</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            text-align: center;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 20px;
            background: #111;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        .header-title {
            font-size: 1.2rem;
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }
        .sub-header {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .section-divider {
            border-top: 1px solid #333;
            margin: 20px 0 15px 0;
            padding-top: 5px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: #111;
            padding-right: 10px;
            display: inline-block;
        }
        .real-label { color: #34c759; }
        .sim-label { color: #0a84ff; }
        .ctrl-label { color: #eda532; }
        
        .profit-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 5px 0 0 0;
            font-variant-numeric: tabular-nums;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .pos { color: #34c759; }
        .neg { color: #ff3b30; }
        .neutral { color: #666; }
        
        .scale-badge {
            font-size: 0.85rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: #222;
            color: #aaa;
            vertical-align: middle;
            border: 1px solid #333;
        }
        
        /* ===== NEW STYLES: Direction Badge ===== */
        .direction-badge {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: bold;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        .direction-long {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            border: 1px solid #34c759;
        }
        .direction-short {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
            border: 1px solid #ff3b30;
        }
        
        /* ===== NEW STYLES: Asset Price Display ===== */
        .asset-prices {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.85rem;
            color: #aaa;
            margin: 8px 0 10px 0;
            padding: 8px;
            background: #0a0a0a;
            border-radius: 6px;
            border: 1px solid #222;
        }
        .asset-price-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .asset-label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .price-value {
            font-family: "Menlo", monospace;
            font-size: 0.9rem;
            font-weight: bold;
            color: #ddd;
        }
        .price-separator {
            color: #333;
            font-size: 1.2rem;
        }
        
        /* ===== NEW STYLES: Scaling Info Display ===== */
        .scaling-info {
            font-size: 0.75rem;
            color: #888;
            text-align: center;
            margin-bottom: 10px;
        }
        .scaling-count {
            color: #ffcc00;
            font-weight: bold;
            font-family: "Menlo", monospace;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        th {
            text-align: left;
            color: #666;
            font-weight: normal;
            padding-bottom: 5px;
            border-bottom: 1px solid #222;
        }
        td {
            padding: 8px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        .val {
            font-weight: bold;
            font-family: "Menlo", monospace;
            text-align: right;
        }
        .row-label {
            text-align: left;
            color: #aaa;
        }
        .z-badge {
            display: inline-block;
            width: 60px;
            text-align: center;
            padding: 3px 0;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            background: #1a1a1a;
            border: 1px solid #333;
        }
        .z-warn { color: #ffcc00; border-color: #665500; }
        .z-crit { color: #ff3b30; border-color: #661111; }
        
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ddd;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-green { color: #34c759; border-color: #1c4425; }
        .btn-red { color: #ff3b30; border-color: #441c1c; }
        .btn-yellow { color: #ffcc00; border-color: #443b00; }
        
        .status-footer {
            margin-top: 20px;
            font-size: 0.7rem;
            color: #444;
            font-family: "Menlo", monospace;
        }
        .collapsible {
            background-color: #222;
            color: #ddd;
            cursor: pointer;
            padding: 12px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 0.9rem;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .active, .collapsible:hover { background-color: #333; }
        
        .content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #111;
            margin-bottom: 20px;
            border-radius: 0 0 8px 8px;
            border: 1px solid #333;
            border-top: none;
        }
        .tab-bar {
            display: flex;
            border-bottom: 1px solid #333;
            background: #151515;
        }
        .tab-btn {
            background: none;
            border: none;
            color: #666;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            flex: 1;
            transition: color 0.2s;
        }
        .tab-btn.active-tab {
            color: #fff;
            border-bottom: 2px solid #34c759;
            background: #1a1a1a;
        }
        .hist-table {
            width: 100%;
            font-size: 0.75rem;
            border-collapse: collapse;
        }
        .hist-table th {
            text-align: left;
            color: #555;
            padding: 8px 10px;
            border-bottom: 1px solid #222;
            font-weight: normal;
        }
        .hist-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #1a1a1a;
            color: #999;
        }
        .badge-long {
            color: #34c759;
            background: rgba(52, 199, 89, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .badge-short {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .profit-pos { color: #34c759; font-weight: bold; }
        .profit-neg { color: #ff3b30; font-weight: bold; }
        
        .history-controls {
            padding: 10px;
            background: #151515;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #888;
        }
        input[type="number"] {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            width: 40px;
        }
        
        /* Enhanced Hurst Display Styles */
        .hurst-indicator {
            font-weight: bold;
            font-family: "Menlo", monospace;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }
        .trend-triangle { font-size: 0.9rem; font-weight: bold; }
        .trend-up { color: #34c759; }
        .trend-down { color: #ff3b30; }
        .trend-ranging {
            color: #ffcc00;
            background: rgba(255, 204, 0, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        .hurst-value { min-width: 35px; text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-title">UNIFIED TERMINAL</div>
        <div class="sub-header" id="asset-display">LOADING...</div>
        
        <div class="section-divider">
            <span class="section-label real-label" id="mode-label">SIMULATION</span>
            <span class="scale-badge" id="ctx-badge">WAIT</span>
        </div>
        
        <!-- ===== ENHANCED P&L SECTION: Added direction badge, prices, scaling ===== -->
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
            <div class="profit-value" id="pnl-display">$0.00</div>
            <span class="direction-badge direction-long" id="direction-badge">FLAT</span>
        </div>
        
        <!-- ===== NEW: Asset Prices Display ===== -->
        <div class="asset-prices" id="asset-prices-container">
            <div class="asset-price-item">
                <span class="asset-label" id="asset1-label">ASSET 1</span>
                <span class="price-value" id="asset1-price">$--</span>
            </div>
            <span class="price-separator">|</span>
            <div class="asset-price-item">
                <span class="asset-label" id="asset2-label">ASSET 2</span>
                <span class="price-value" id="asset2-price">$--</span>
            </div>
        </div>
        
        <!-- ===== NEW: Scaling Count and Position Details ===== -->
        <div class="scaling-info">
            <span id="scaling-display">Scaling: <span class="scaling-count">0</span></span>
            <span style="margin: 0 8px; color: #333;">‚Ä¢</span>
            <span id="pos-detail">FLAT</span>
        </div>
        
        <table>
            <thead><tr><th>TIMEFRAME</th><th style="text-align: center;">Z-SCORE</th><th style="text-align: right;">TREND</th></tr></thead>
            <tbody>
                <tr><td class="row-label">5s (Tactical)</td><td style="text-align: center;"><span class="z-badge" id="z-5s">0.00</span></td><td class="val" id="trend-5s">--</td></tr>
                <tr><td class="row-label">1m (Primary)</td><td style="text-align: center;"><span class="z-badge" id="z-1m">0.00</span></td><td class="val" id="trend-1m">--</td></tr>
                <tr><td class="row-label" id="label-htf">HTF (Bias)</td><td style="text-align: center;"><span class="z-badge" id="z-1h">0.00</span></td><td class="val" id="trend-1h">--</td></tr>
            </tbody>
        </table>
        
        <div class="section-divider"><span class="section-label sim-label">MARKET REGIME</span><span style="font-size: 0.7rem; color: #444;" id="tick-time">--:--:--</span></div>
        
        <table>
            <tr><td class="row-label">CORRELATION</td><td class="val" id="reg-corr">0.000</td></tr>
            <tr><td class="row-label">VOL SYNC RATIO</td><td class="val" id="reg-vol">0.000</td></tr>
            <tr><td class="row-label">HURST (PRIMARY)</td><td class="val" id="reg-hurst-p">0.50</td></tr>
            <tr><td class="row-label">HURST (SECONDARY)</td><td class="val" id="reg-hurst-s">0.50</td></tr>
            <tr><td class="row-label">HURST (PAIR)</td><td class="val" id="reg-hurst-pair">0.50</td></tr>
            <tr><td class="row-label">RSI (14)</td><td class="val" id="reg-rsi">50.0</td></tr>
        </table>
        
        <div class="section-divider"><span class="section-label ctrl-label">STRATEGY CONTROL</span></div>
        
        <div style="background: #151515; padding: 10px; border-radius: 8px; border: 1px solid #222; font-size: 0.75rem; color: #aaa; text-align: left; margin-bottom: 15px;">
            <span style="color: #666; display: block; margin-bottom: 4px;">REASONING:</span>
            <span id="reasoning-text">System Initializing...</span>
        </div>
        
        <div class="btn-grid">
            <button class="btn btn-green" onclick="sendCommand('RESUME_TRADING')">‚ñ∂ RESUME</button>
            <button class="btn btn-yellow" onclick="sendCommand('SET_SOFT_PAUSE')">‚è∏ PAUSE</button>
            <button class="btn btn-red" onclick="sendCommand('CLOSE_ALL_POSITIONS')">üõë CLOSE ALL</button>
            <button class="btn" style="border-color: #0a84ff; color: #0a84ff;" onclick="switchMode()">üîÑ SWITCH MODE</button>
        </div>
        
        <div class="btn-grid" style="margin-top: 10px;">
            <button id="btn-set-target" class="btn" style="grid-column: span 2; border-color: #34c759; color: #34c759;" onclick="setTargetProfit()">üéØ TARGET: --</button>
        </div>
        
        <button type="button" class="collapsible" onclick="toggleHistory()">
            <span>üìú Open Position Monitor</span>
        </button>
        <div class="content" id="history-content">
            <div class="tab-bar">
                <button class="tab-btn" onclick="switchTab('SIM')" id="tab-sim">SIMULATED</button>
                <button class="tab-btn active-tab" onclick="switchTab('REAL')" id="tab-real">REAL MONEY</button>
            </div>
            <div class="history-controls">
                <span>Show last <input type="number" id="daysFilter" value="7" min="1" onchange="loadHistory(currentHistMode)"> days</span>
                <button onclick="loadHistory(currentHistMode)" style="background:none; border:1px solid #333; color:#666; font-size:0.6rem; cursor:pointer; border-radius:3px;">REFRESH</button>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="hist-table">
                    <thead>
                        <tr><th>Time</th><th style="text-align: center;">Dir</th><th style="text-align: center;">Val ($)</th><th style="text-align: center;">Scale</th><th style="text-align: right;">Profit ($)</th></tr>
                    </thead>
                    <tbody id="history-body">
                        <tr><td colspan="5" style="text-align: center; padding: 15px;">Click to Load</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <button type="button" class="collapsible" onclick="toggleClosedHistory()">
            <span>üèÅ Closed Trade History</span>
        </button>
        <div class="content" id="closed-history-content">
            <div class="tab-bar">
                <button class="tab-btn" onclick="switchClosedTab('SIM')" id="tab-closed-sim">SIMULATED</button>
                <button class="tab-btn active-tab" onclick="switchClosedTab('REAL')" id="tab-closed-real">REAL MONEY</button>
            </div>
            <div class="history-controls">
                <span>Show last <input type="number" id="closedDaysFilter" value="30" min="1" onchange="loadClosedHistory(currentClosedMode)"> days</span>
                <button onclick="loadClosedHistory(currentClosedMode)" style="background:none; border:1px solid #333; color:#666; font-size:0.6rem; cursor:pointer; border-radius:3px;">REFRESH</button>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="hist-table">
                    <thead>
                        <tr><th>Close Time</th><th style="text-align: center;">Dir</th><th style="text-align: center;">Dur</th><th style="text-align: right;">Realized ($)</th></tr>
                    </thead>
                    <tbody id="closed-history-body">
                        <tr><td colspan="4" style="text-align: center; padding: 15px;">Click to Load</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="status-footer" id="status-footer">Connecting to Unified Engine...</div>
    </div>
    
    <script>
        const CONFIG_URL = '';
        const THRESHOLDS = { corr_min: 0.16, vol_min: 0.17 };
        // ============================================================
        // FIX: DYNAMIC DATA DIRECTORY RESOLUTION
        // ============================================================
        function getPosDirFromUrl() {
            try {
                // Parse the ?config= parameter from the URL
                const params = new URLSearchParams(window.location.search);
                const configName = params.get('config'); 
                
                if (configName) {
                    // Logic: Transform 'config_ETH_BTC_5m1m.json' -> 'aggregated_ETH_BTC_5m1m'
                    // 1. Replace prefix 'config_' with 'aggregated_'
                    let dirName = configName.replace('config_', 'aggregated_');
                    
                    // 2. Remove '.json' extension if present
                    if (dirName.toLowerCase().endsWith('.json')) {
                        dirName = dirName.substring(0, dirName.length - 5);
                    }
                    console.log("Dynamic POS_DIR resolved:", dirName);
                    return dirName;
                }
            } catch (e) {
                console.error("Error resolving data directory:", e);
            }
            // Fallback default if no URL param exists
            return "aggregated_SOL_MELANIA_5m1m"; 
        }

        const POS_DIR = getPosDirFromUrl();
        
        let currentHistMode = 'REAL';       // Changed default to REAL
        let currentClosedMode = 'REAL';     // Changed default to REAL
        
        function toggleHistory() {
            const btn = document.querySelector(".collapsible");
            const content = document.getElementById("history-content");
            btn.classList.toggle("active");
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = "400px";
                loadHistory(currentHistMode);
            }
        }
        
        function toggleClosedHistory() {
            const btn = document.querySelectorAll(".collapsible")[1];
            const content = document.getElementById("closed-history-content");
            btn.classList.toggle("active");
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = "400px";
                loadClosedHistory(currentClosedMode);
            }
        }
        
        function switchTab(mode) {
            currentHistMode = mode;
            document.getElementById('tab-sim').className = mode === 'SIM' ? 'tab-btn active-tab' : 'tab-btn';
            document.getElementById('tab-real').className = mode === 'REAL' ? 'tab-btn active-tab' : 'tab-btn';
            loadHistory(mode);
        }
        
        function switchClosedTab(mode) {
            currentClosedMode = mode;
            document.getElementById('tab-closed-sim').className = mode === 'SIM' ? 'tab-btn active-tab' : 'tab-btn';
            document.getElementById('tab-closed-real').className = mode === 'REAL' ? 'tab-btn active-tab' : 'tab-btn';
            loadClosedHistory(mode);
        }
        
        async function loadHistory(mode) {
            const tbody = document.getElementById('history-body');
            const daysLimit = parseInt(document.getElementById('daysFilter').value);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 10px;">Loading data...</td></tr>';
            
            const filename = mode === 'REAL' ? 'real_open_positions.json' : 'sim_open_positions.json';
            const url = `${POS_DIR}/${filename}?t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("File not found");
                const data = await response.json();
                
                let positions = Array.isArray(data) ? data : (data.simulation?.positions || data.real?.positions || Object.values(data));
                const now = new Date();
                const filtered = positions.filter(p => {
                    const openTime = new Date(p.opened_at || p.timestamp);
                    return (now - openTime) / (1000 * 60 * 60 * 24) <= daysLimit;
                });
                
                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 15px; color: #666;">No positions in last ${daysLimit} days</td></tr>`;
                    return;
                }
                
                let html = '';
                filtered.forEach(p => {
                    const date = new Date(p.opened_at || p.timestamp);
                    const timeStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    const rawDir = (p.direction || "UNKNOWN").toUpperCase();
                    const displayDir = rawDir.startsWith('LONG') ? '<span class="badge-long">L</span>' : '<span class="badge-short">S</span>';
                    
                    let totalValue = 0;
                    if (p.legs) totalValue = p.legs.reduce((sum, leg) => sum + (leg.value_usd || 0), 0);
                    else if (p.aggregated_metrics) totalValue = p.aggregated_metrics.total_value_usd || 0;
                    
                    const scale = p.aggregated_metrics ? (p.aggregated_metrics.actual_component_count || 1) : 1;
                    const pnl = parseFloat(p.pnl || 0);
                    const pnlClass = pnl >= 0 ? 'profit-pos' : 'profit-neg';
                    
                    html += `<tr>
                        <td>${timeStr}</td>
                        <td style="text-align: center;">${displayDir}</td>
                        <td style="text-align: center;">$${totalValue.toFixed(0)}</td>
                        <td style="text-align: center;">${scale}</td>
                        <td style="text-align: right;" class="${pnlClass}">$${pnl.toFixed(2)}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 15px; color: #ff3b30;">Error loading ${mode} data</td></tr>`;
            }
        }
        
        async function loadClosedHistory(mode) {
            const tbody = document.getElementById('closed-history-body');
            const daysLimit = parseInt(document.getElementById('closedDaysFilter').value);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 10px;">Loading data...</td></tr>';
            
            const filename = mode === 'REAL' ? 'real_closed_positions.json' : 'sim_closed_positions.json';
            const url = `${POS_DIR}/${filename}?t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("File not found");
                const data = await response.json();
                
                let positions = [];
                if (Array.isArray(data)) {
                    positions = data;
                } else if (data.simulation && Array.isArray(data.simulation)) {
                    positions = data.simulation;
                } else if (data.real && Array.isArray(data.real)) {
                    positions = data.real;
                } else if (data.simulation?.closed_positions) {
                    positions = data.simulation.closed_positions;
                } else {
                    positions = Object.values(data);
                }
                
                const now = new Date();
                const filtered = positions.filter(p => {
                    const closeTime = new Date(p.closed_at || p.timestamp || p.last_updated);
                    return (now - closeTime) / (1000 * 60 * 60 * 24) <= daysLimit;
                });
                
                filtered.sort((a, b) => new Date(b.closed_at || b.timestamp) - new Date(a.closed_at || a.timestamp));
                
                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 15px; color: #666;">No closed trades in last ${daysLimit} days</td></tr>`;
                    return;
                }
                
                let html = '';
                filtered.forEach(p => {
                    const date = new Date(p.closed_at || p.timestamp || Date.now());
                    const timeStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    const rawDir = (p.direction || "UNKNOWN").toUpperCase();
                    const displayDir = rawDir.startsWith('LONG') ? '<span class="badge-long">L</span>' : '<span class="badge-short">S</span>';
                    
                    let realizedPnL = 0;
                    if (p.realized_pnl !== undefined) realizedPnL = parseFloat(p.realized_pnl);
                    else if (p.pnl !== undefined) realizedPnL = parseFloat(p.pnl);
                    else if (p.final_pnl !== undefined) realizedPnL = parseFloat(p.final_pnl.pnl_usd || 0);
                    
                    const pnlClass = realizedPnL >= 0 ? 'profit-pos' : 'profit-neg';
                    
                    let durationStr = "--";
                    if (p.opened_at && p.closed_at) {
                        const diffMs = new Date(p.closed_at) - new Date(p.opened_at);
                        const diffMins = Math.round(diffMs / 60000);
                        const diffHours = (diffMins / 60).toFixed(1);
                        durationStr = `${diffHours}h`;
                    }
                    
                    html += `<tr>
                        <td>${timeStr}</td>
                        <td style="text-align: center;">${displayDir}</td>
                        <td style="text-align: center;">${durationStr}</td>
                        <td style="text-align: right;" class="${pnlClass}">$${realizedPnL.toFixed(2)}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 15px; color: #ff3b30;">Error loading ${mode} history: ${e.message}</td></tr>`;
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch(`${CONFIG_URL}/live_market_state?t=${Date.now()}`);
                if (!response.ok) throw new Error("API Offline");
                const data = await response.json();
                render(data);
                document.getElementById('status-footer').textContent = `SYNCED: ${new Date().toLocaleTimeString()}`;
                document.getElementById('status-footer').style.color = "#444";
            } catch (e) {
                document.getElementById('status-footer').textContent = "CONNECTION LOST";
                document.getElementById('status-footer').style.color = "#ff3b30";
            }
        }
        
        function render(data) {
            const portfolio = data.portfolio || { mode: 'SIM' };
            
            document.getElementById('asset-display').textContent = data.symbol || "UNKNOWN";
            document.getElementById('tick-time').textContent = new Date(data.asof).toLocaleTimeString();
            
            const baseAsset = data.asset_pair_info?.base_asset || "PRIMARY";
            const quoteAsset = data.asset_pair_info?.quote_asset || "SECONDARY";
            
            const hurstRows = document.querySelectorAll('.row-label');
            hurstRows.forEach(row => {
                if (row.textContent === 'HURST (PRIMARY)' || row.textContent.startsWith('HURST (') && row.textContent.includes('PRIMARY')) {
                    row.textContent = `HURST (${baseAsset})`;
                } else if (row.textContent === 'HURST (SECONDARY)' || row.textContent.startsWith('HURST (') && row.textContent.includes('SECONDARY')) {
                    row.textContent = `HURST (${quoteAsset})`;
                }
            });
            
            const modeLabel = document.getElementById('mode-label');
            if(portfolio.mode === 'REAL') {
                modeLabel.textContent = "REAL EXECUTION";
                modeLabel.className = "section-label real-label";
                modeLabel.style.color = "#34c759";
            } else {
                modeLabel.textContent = "SIMULATION MODE";
                modeLabel.className = "section-label sim-label";
                modeLabel.style.color = "#0a84ff";
            }
            
            const permit = data.meta?.trading_permit || "UNKNOWN";
            const ctxBadge = document.getElementById('ctx-badge');
            if (ctxBadge) {
                if (permit === "ALL") {
                    ctxBadge.textContent = "ACTIVE";
                    ctxBadge.style.color = "#34c759";
                    ctxBadge.style.borderColor = "#34c759";
                    ctxBadge.style.background = "rgba(52, 199, 89, 0.1)";
                } else if (permit === "CLOSE_ONLY") {
                    ctxBadge.textContent = "PAUSED";
                    ctxBadge.style.color = "#ffcc00";
                    ctxBadge.style.borderColor = "#ffcc00";
                    ctxBadge.style.background = "rgba(255, 204, 0, 0.1)";
                } else {
                    ctxBadge.textContent = "LOCKED";
                    ctxBadge.style.color = "#ff3b30";
                    ctxBadge.style.borderColor = "#ff3b30";
                    ctxBadge.style.background = "rgba(255, 59, 48, 0.1)";
                }
            }
            
            // ========================================================================
            // ENHANCED P&L SECTION: Calculate total PnL from positions
            // ========================================================================
            let totalPnL = 0;
            if (portfolio.positions && Array.isArray(portfolio.positions)) {
                totalPnL = portfolio.positions.reduce((sum, pos) => {
                    return sum + (parseFloat(pos.pnl) || 0);
                }, 0);
            }
            
            const pnlEl = document.getElementById('pnl-display');
            pnlEl.textContent = (totalPnL >= 0 ? "+$" : "-$") + Math.abs(totalPnL).toFixed(2);
            pnlEl.className = `profit-value ${totalPnL > 0 ? 'pos' : (totalPnL < 0 ? 'neg' : 'neutral')}`;
            
            
            // ========================================================================
            // ENHANCED P&L SECTION: Extract and display asset prices
            // ========================================================================
            const solPrice = data.prices?.primary || 0;
            const melaniaPrice = data.prices?.reference || 0;
            const solSymbol = data.asset_pair_info?.base_asset || "SOL";
            const melaniaSymbol = data.asset_pair_info?.quote_asset || "MELANIA";
            
            document.getElementById('asset1-label').textContent = solSymbol;
            document.getElementById('asset2-label').textContent = melaniaSymbol;
            document.getElementById('asset1-price').textContent = solPrice > 0 ? `$${solPrice.toFixed(2)}` : "$--";
            document.getElementById('asset2-price').textContent = melaniaPrice > 0 ? `$${melaniaPrice.toFixed(4)}` : "$--";
            
            
            // ========================================================================
            // ENHANCED P&L SECTION: Extract trade direction and scaling count
            // ========================================================================
            let tradeDirection = "FLAT";
            let scalingCount = 0;
            
            if (portfolio.positions && portfolio.positions.length > 0) {
                const firstPos = portfolio.positions[0];
                
                // Get direction (clean "LONG"/"SHORT" format)
                tradeDirection = (firstPos.direction || "FLAT").toUpperCase();
                if (tradeDirection === "FLAT" && firstPos.aggregated_metrics) {
                    tradeDirection = (firstPos.aggregated_metrics.direction || "FLAT").toUpperCase();
                }
                
                // Get scaling count
                if (firstPos.aggregated_metrics) {
                    scalingCount = firstPos.aggregated_metrics.actual_component_count || 0;
                }
                if (scalingCount === 0) {
                    scalingCount = portfolio.count || 0;
                }
            }
            
            // Update direction badge
            const directionBadge = document.getElementById('direction-badge');
            if (tradeDirection === "LONG") {
                directionBadge.textContent = "LONG ‚ñ≤";
                directionBadge.className = "direction-badge direction-long";
            } else if (tradeDirection === "SHORT") {
                directionBadge.textContent = "SHORT ‚ñº";
                directionBadge.className = "direction-badge direction-short";
            } else {
                directionBadge.textContent = "FLAT";
                directionBadge.className = "direction-badge";
                directionBadge.style.background = "#222";
                directionBadge.style.color = "#666";
                directionBadge.style.border = "1px solid #333";
            }
            
            // Update scaling display
            document.getElementById('scaling-display').innerHTML = 
                `Scaling: <span class="scaling-count">${scalingCount}</span>`;
            
            // Update position detail
            const positionCount = portfolio.positions?.length || 0;
            document.getElementById('pos-detail').textContent = positionCount > 0 
                ? `${positionCount} Active` 
                : "No Positions";
            
            
            updateZRow('z-5s', 'trend-5s', data.regression_5s?.zscore);
            updateZRow('z-1m', 'trend-1m', data.regression?.zscore);
            updateZRow('z-1h', 'trend-1h', data.regression_htf?.zscore);
            
            if (data.regression_htf?.timeframe) document.getElementById('label-htf').textContent = `${data.regression_htf.timeframe} (Bias)`;
            
            updateVal('reg-corr', (data.regression?.correlation || 0).toFixed(3), Math.abs(data.regression?.correlation || 0) < THRESHOLDS.corr_min ? 'bad' : 'good');
            updateVal('reg-vol', (data.regime_assessment?.volatility_sync?.ratio || 0).toFixed(3), (data.regime_assessment?.volatility_sync?.ratio || 0) < THRESHOLDS.vol_min ? 'bad' : 'good');
            
            const h_p = data.regime_assessment?.hurst || 0.5;
            const h_s = data.regime_assessment?.hurst_secondary || 0.5;
            const h_pair = data.regime_assessment?.hurst_spread || 0.5;
            const sol_trend_beta = data.regime_assessment?.sol_trend_beta || 0.0;
            const melania_trend_beta = data.regime_assessment?.melania_trend_beta || 0.0;
            const spread_trend_beta = data.regime_assessment?.spread_trend_beta || 0.0;
            
            renderEnhancedHurst('reg-hurst-p', h_p, sol_trend_beta);
            renderEnhancedHurst('reg-hurst-s', h_s, melania_trend_beta);
            renderEnhancedHurst('reg-hurst-pair', h_pair, spread_trend_beta);
            
            updateVal('reg-rsi', (data.indicators?.rsi || 50).toFixed(1), (data.indicators?.rsi || 50) > 70 || (data.indicators?.rsi || 50) < 30 ? 'warn' : 'neutral');
            
            document.getElementById('reasoning-text').textContent = data.trading_signal?.current_recommendation?.reasoning || "No Signal Data";
            
            const targetVal = data.active_strategy_params?.dollar_target;
            const targetBtn = document.getElementById('btn-set-target');
            if (targetBtn) {
                if (targetVal !== undefined && targetVal !== null) {
                    targetBtn.textContent = `üéØ TARGET: $${parseFloat(targetVal).toFixed(2)}`;
                } else {
                    targetBtn.textContent = `üéØ SET TARGET PROFIT`;
                }
            }
        }
        
        function renderEnhancedHurst(id, val, trendBeta) {
            const el = document.getElementById(id);
            if (val === 0.5) {
                el.innerHTML = '<span class="hurst-value">WAIT</span>';
                el.style.color = '#666';
                return;
            }
            
            let indicator = '';
            let colorClass = '';
            if (val > 0.6) {
                if (trendBeta > 0.01) {
                    indicator = '<span class="trend-triangle trend-up">‚ñ≤</span>';
                } else if (trendBeta < -0.01) {
                    indicator = '<span class="trend-triangle trend-down">‚ñº</span>';
                } else {
                    indicator = '<span class="trend-ranging">~</span>';
                }
                colorClass = '#ddd';
            } else {
                indicator = '<span class="trend-ranging">‚óÜ</span>';
                colorClass = '#aaa';
            }
            
            el.innerHTML = `<div class="hurst-indicator"><span class="hurst-value">${val.toFixed(2)}</span>${indicator}</div>`;
            el.style.color = colorClass;
        }
        
        function updateZRow(zId, tId, val) {
            const el = document.getElementById(zId);
            const tEl = document.getElementById(tId);
            if (val === undefined) {
                el.textContent = "--";
                tEl.textContent = "--";
                return;
            }
            el.textContent = val.toFixed(2);
            const absVal = Math.abs(val);
            if (absVal > 3.0) el.className = "z-badge z-crit";
            else if (absVal > 2.0) el.className = "z-badge z-warn";
            else el.className = "z-badge";
            
            if (val > 0.5) {
                tEl.textContent = "RICH (SELL)";
                tEl.style.color = "#ff3b30";
            } else if (val < -0.5) {
                tEl.textContent = "CHEAP (BUY)";
                tEl.style.color = "#34c759";
            } else {
                tEl.textContent = "FAIR VALUE";
                tEl.style.color = "#666";
            }
        }
        
        function updateVal(id, text, status) {
            const el = document.getElementById(id);
            el.textContent = text;
            if(status === 'bad') el.style.color = '#ff3b30';
            else if(status === 'good') el.style.color = '#34c759';
            else if(status === 'warn') el.style.color = '#ffcc00';
            else el.style.color = '#ddd';
        }
        
        async function setTargetProfit() {
            const btn = document.getElementById('btn-set-target');
            let currentText = btn.textContent;
            let currentVal = "5.0";
            if (currentText.includes('$')) {
                const parts = currentText.split('$');
                if (parts.length > 1) {
                    currentVal = parts[1].trim();
                }
            }
            
            let dollarVal = prompt(`Current Profit Target: $${currentVal}\n\nEnter new Dollar Profit Target:`, currentVal);
            if (dollarVal === null) return;
            dollarVal = parseFloat(dollarVal);
            if (isNaN(dollarVal) || dollarVal <= 0) {
                alert("Please enter a valid positive number.");
                return;
            }
            
            const payload = { action: "SET_TARGET_PROFIT", dollar_target: dollarVal };
            try {
                await fetch(`${CONFIG_URL}/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                alert(`Target Updated to $${dollarVal}. Display will update shortly.`);
                updateStats();
            } catch (e) {
                alert("Error: " + e);
            }
        }
        
        async function switchMode() {
            const currentLabel = document.getElementById('mode-label').textContent;
            const targetMode = currentLabel.includes("REAL") ? "SIM" : "REAL";
            let confirmMsg = `Switch to ${targetMode} mode?`;
            let payload = { action: "SWITCH_MODE", mode: targetMode, method: "HARD" };
            
            if (targetMode === "SIM") {
                confirmMsg += "\n\nWARNING: This will switch mode!";
                const userConfirm = prompt(confirmMsg + "\n\nType 'CONFIRM' to proceed:");
                if (userConfirm !== "CONFIRM") {
                    alert("Switch cancelled.");
                    return;
                }
                payload.confirmation = "I understand this closes REAL positions with real money";
            } else {
                if (!confirm(confirmMsg)) return;
            }
            
            try {
                const response = await fetch(`${CONFIG_URL}/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const respData = await response.json();
                alert(`Result: ${respData.status}`);
                updateStats();
            } catch (e) {
                alert("Error: " + e);
            }
        }
        
        async function sendCommand(action) {
            if (!confirm(`Execute ${action}?`)) return;
            try {
                await fetch(`${CONFIG_URL}/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: action })
                });
                alert("Command Sent");
                updateStats();
            } catch (e) {
                alert("Error: " + e);
            }
        }
        
        setInterval(updateStats, 1000);
        updateStats();
    </script>
</body>
</html>
